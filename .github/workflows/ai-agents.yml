# GitHub Actions Workflow - AI Agents Scheduler
# Runs autonomous AI agents on schedule
# 
# ‚ö†Ô∏è NOTE: Trend Detector is DISABLED here - use detect-trending.yml instead (avoids duplication)
# 
# Agents:
# - Trend Detector: DISABLED (use detect-trending.yml)
# - Fact Checker: Daily at 2 AM UTC
# - Bias Auditor: Daily at 3:30 AM UTC (offset from learning-agent)
# - Multi-Perspective: On-demand via manual trigger

name: AI Agents Scheduler

concurrency:
  group: ai-agents-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    # Trend Detector - DISABLED (use detect-trending.yml instead to avoid duplicate API calls)
    # - cron: '0 */6 * * *'
    # Fact Checker - Daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Bias Auditor - Daily at 3:30 AM UTC (offset 30 min from learning-agent to avoid race condition)
    - cron: '30 3 * * *'
  
  # Allow manual triggers
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to run'
        required: true
        type: choice
        options:
          - fact_checker
          - bias_auditor
          - multi_perspective
          - all

jobs:
  run-agents:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: none
    env:
      SITE_URL: https://thotnet-core.vercel.app
      AGENTS_SCHEDULER_KEY: ${{ secrets.AGENTS_SCHEDULER_KEY }}
    
    steps:
      - name: Run scheduled/selected agent(s)
        env:
          AGENT_INPUT: ${{ github.event.inputs.agent }}
          SCHEDULE: ${{ github.event.schedule }}
          REQUEST_ID: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euo pipefail

          if [ -z "${AGENTS_SCHEDULER_KEY:-}" ]; then
            echo "‚ùå Missing AGENTS_SCHEDULER_KEY secret"
            exit 1
          fi

          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${SCHEDULE:-<none>}"
          echo "Input agent: ${AGENT_INPUT:-<none>}"
          echo "Request ID: ${REQUEST_ID}"

          agents=()

          # Scheduled runs map cron -> agent
          if [ "${{ github.event_name }}" = "schedule" ]; then
            case "${SCHEDULE}" in
              '0 2 * * *') agents+=("fact_checker") ;;
              '30 3 * * *') agents+=("bias_auditor") ;;
              *)
                echo "‚ÑπÔ∏è No agent mapped for this schedule: ${SCHEDULE}"
                exit 0
                ;;
            esac
          else
            # Manual runs
            case "${AGENT_INPUT}" in
              fact_checker|bias_auditor|multi_perspective)
                agents+=("${AGENT_INPUT}")
                ;;
              all)
                agents+=("fact_checker" "bias_auditor" "multi_perspective")
                ;;
              *)
                echo "‚ùå Unknown agent input: ${AGENT_INPUT}"
                exit 1
                ;;
            esac
          fi

          echo "Agents to run: ${agents[*]}"

          mkdir -p /tmp/ai-agents

          for agent in "${agents[@]}"; do
            echo "üöÄ Running agent: ${agent}"

            # `--fail-with-body` makes HTTP 4xx/5xx fail the step (and prints body)
            # Retries help with transient Vercel/network hiccups.
            curl --fail-with-body --show-error --silent \
              --connect-timeout 15 --max-time 240 \
              --retry 6 --retry-delay 2 --retry-all-errors \
              -X POST "${SITE_URL}/api/agents/run" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${AGENTS_SCHEDULER_KEY}" \
              -H "X-Request-Id: ${REQUEST_ID}" \
              -d "{\"agentType\":\"${agent}\",\"requestId\":\"${REQUEST_ID}\"}" \
              | tee "/tmp/ai-agents/agent-${agent}-response.json"

            echo "‚úÖ Agent ${agent} completed"
          done

      - name: Upload responses (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ai-agents-responses-${{ github.run_id }}-${{ github.run_attempt }}
          path: /tmp/ai-agents/*.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Notify on failure
        if: failure()
        run: |
          echo "Agent execution failed. Check logs for details."
          # Add Slack/Discord notification here if needed
